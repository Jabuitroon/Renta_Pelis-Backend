generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  user_id      String     @id @default(uuid())
  name         String
  lastName     String     @map("last_name")
  phone        String?
  email        String     @unique
  backupEmail  String?
  passwordHash String     @map("password_hash")
  country      String?    @default("CO")
  language     String?    @default("es-Es")
  favorites    Favorite[]
  reviews      Review[]
  role         UserRole   @default(cliente)
  avatar       String?

  createdAt          DateTime @default(now()) @map("created_at")
  updateAt           DateTime @updatedAt
  phoneConfirm       Boolean  @default(false)
  emailConfirm       Boolean  @default(false)
  backupEmailConfirm Boolean  @default(false)

  twoFactorEnable Boolean   @default(false)
  twoFactorSecret String?
  sessions        Session[]

  status       UserStatusEnum   @default(ACTIVE)
  authProvider AuthProviderEnum @default(LOCAL)
  orders       Order[]

  @@index([email])
  @@index([createdAt])
  @@map("tbl_user")
}

model Session {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [user_id], onDelete: Cascade)

  refreshToken String

  userAgent String?
  ipAddress String?
  location  String?

  isActive Boolean @default(true)

  expiresAt  DateTime?
  createdAt  DateTime  @default(now())
  lastUsedAt DateTime  @updatedAt

  @@index([userId])
  @@index([userAgent])
  @@index([ipAddress])
}

enum UserStatusEnum {
  ACTIVE
  INACTIVE
  DRAFT
  BLOCKED
}

enum AuthProviderEnum {
  LOCAL
  GOOGLE
  FACEBOOK
  OTHER
}

enum UserRole {
  admin
  cliente
}

model Movie {
  imdbId     String       @id @map("imdb_id")
  title      String
  year       String?
  type       String?
  rated      String?
  released   DateTime?
  runtime    String?
  plot       String?
  language   String?
  country    String?
  awards     String?
  poster     String?
  prices     MoviePrice[]
  createdAt  DateTime     @default(now()) @map("created_at")
  favorites  Favorite[]
  genres     MovieGenre[]
  reviews    Review[]
  orderItems OrderItem[]

  @@map("tbl_movie")
}

model MovieGenre {
  imdbId String
  genre  GenreType
  movie  Movie     @relation(fields: [imdbId], references: [imdbId], onDelete: Cascade)

  @@id([imdbId, genre])
  @@map("tbl_movie_genre")
}

model Favorite {
  userId String @map("user_id")
  imdbId String @map("imdb_id")
  movie  Movie  @relation(fields: [imdbId], references: [imdbId], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [user_id], onDelete: Cascade)

  @@id([userId, imdbId])
  @@map("tbl_favorite")
}

model MoviePrice {
  id      Int    @id @default(autoincrement())
  movieId String @map("movie_id")
  movie   Movie  @relation(fields: [movieId], references: [imdbId], onDelete: Cascade)

  // Define si es 'RENT' o 'BUY'
  transactionType TransactionType @map("transaction_type")

  // Calidad: 'HD', '4K'
  quality QualityOption

  price Decimal @db.Decimal(10, 2)

  @@unique([movieId, transactionType, quality])
  @@map("tbl_movie_prices")
}

enum TransactionType {
  RENT
  BUY
}

enum QualityOption {
  p720
  p1080
  p4k
}

model Review {
  reviewId  Int      @id @default(autoincrement()) @map("review_id")
  rating    Int
  comment   String?
  userId    String   @map("user_id")
  imdbId    String   @map("imdb_id")
  createdAt DateTime @default(now()) @map("created_at")
  movie     Movie    @relation(fields: [imdbId], references: [imdbId], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [user_id], onDelete: Cascade)

  @@unique([userId, imdbId])
  @@map("tbl_review")
}

enum GenreType {
  // Acci√≥n_y_Aventuras
  Anime
  Drama
  Documental
  Fantasia
  Romance
  Comedia
  Horror
  Ninos
  Ciencia_ficcion
  Misterio
  Thriller
}

model Order {
  orderId     String      @id @default(uuid()) @map("order_id")
  userId      String      @map("user_id")
  totalAmount Float       @map("total_amount")
  status      OrderStatus @default(PENDING)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  user  User        @relation(fields: [userId], references: [user_id], onDelete: Cascade)
  items OrderItem[]

  @@index([userId])
  @@map("tbl_order")
}

enum OrderStatus {
  PENDING // Pendiente por pagar
  PAID // Pagada
  CANCELED // Cancelada
  REFUNDED // Reembolsada
}

model OrderItem {
  id      String @id @default(uuid())
  orderId String @map("order_id")
  imdbId  String @map("imdb_id")
  price   Float // Precio al momento de la compra

  // Relaciones
  order Order @relation(fields: [orderId], references: [orderId], onDelete: Cascade)
  movie Movie @relation(fields: [imdbId], references: [imdbId])

  @@map("tbl_order_item")
}
